<!DOCTYPE html>
<html>
  <head>
    <title>SwinburneFAQ Bot</title>
    <link rel="stylesheet" href="./static/css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@0.21.1/dist/axios.min.js"></script>
    <style>    /* 设置body背景颜色和字体 */
      body {
        background-color: #f5f5f5;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }
      
      /* 设置标题样式 */
      h1 {
        text-align: center;
        color: #333;
      }
      
      /* 设置聊天框样式 */
      #chat-box {
        max-width: 600px;
        margin: 0 auto;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        padding: 16px;
        overflow-y: scroll; /* 添加此行 */
        max-height: 350px; /* 添加此行，设置最大高度以限制滚动条出现的高度 */
      }
      
      /* 设置消息气泡样式 */
      #chat-box li {
        list-style-type: none;
        padding: 8px 16px;
        border-radius: 16px;
        margin-bottom: 8px;
      }
      
      #chat-box li:nth-child(odd) {
        background-color: #e6e6e6;
        margin-right: 40px;
      }
      
      #chat-box li:nth-child(even) {
        background-color: #b3e6ff;
        margin-left: 40px;
      }
      
      /* 设置输入框和按钮样式 */
      .bottom {
        display: flex;
        justify-content: center;
        margin-top: 16px;
      }
      
      #message-input {
        /* flex-grow: 1; */
        width: 650px;
        padding: 8px 16px;
        border-radius: 20px;
        border: 1px solid #ccc;
      }
      
      button {
        margin-left: 8px;
        padding: 8px 16px;
        border-radius: 20px;
        background-color: #4CAF50;
        color: #fff;
        border: none;
        cursor: pointer;
      }</style>
  </head>
  <body>
    <div id="app">
      <h1>SwinburneFAQ Bot</h1>
      <div class="chat-input-container">
        <div class="input-container">
          <input v-model="query" placeholder="Enter your message" />
          <button @click="sendQuery" :disabled="!query || isSending" :class="{ 'loading': isSending }">
            <span v-if="!isSending">Send</span>
            <div v-else class="loading-spinner"></div>
          </button>
        </div>
        <div class="similar-questions" v-if="showSimilarQuestions" :class="{ show: showSimilarQuestions }">
          <ul>
            <li v-for="question in similarQuestions" @click="fillInput(question.text)">{{ question.text }}</li>
          </ul>
        </div>
      </div>
      <div ref="chatContainer" class="chat-container">

        <ul>
          <li v-for="message in chatHistory">
            <strong>{{ message.sender }}:</strong> {{ message.content }}
          </li>
        </ul>
      </div>

      <div class="sidebar">
        <h2>Top 5 Questions</h2>
        <ul>
          <li v-for="(question, index) in topQuestions" :key="index" @click="sendQuery(question.question_text)">
            {{ question.question_text }}
          </li>
        </ul>
      </div>
    </div>


    <script>
      new Vue({
        el: '#app',
        mounted() {
            this.fetchTopQuestions();
        },
        data: {
          query: '',
          chatHistory: [],
          similarQuestions: [],
          isFillingInput: false,
          isSending: false,
          topQuestions: []
        },
        computed: {
          showSimilarQuestions() {
            return this.query.trim().length > 0 && this.similarQuestions.length > 0;
          }
        },
        computed: {
          chatBoxDisplay() {
            return this.chatHistory.length === 0 ? 'none' : 'block';
          }
        },
        methods: {
          async sendQuery(question = null) {
            let query = question ? question : this.query;
            this.isSending = true;
            const response = await axios.post('http://127.0.0.1:5000/get_response', {
              query: query
            });
            this.chatHistory.push({
              sender: 'Human',
              content: query
            });
            this.chatHistory.push({
              sender: 'AI',
              content: response.data.response
            });
            this.query = '';
            this.isSending = false;
            this.$nextTick(() => {
              this.scrollToBottom();
              this.fetchTopQuestions();
            });
          },
          async fetchSimilarQuestions() {
            if (!this.isFillingInput) {
              try {
                const response = await axios.post('http://127.0.0.1:5000/get_similar_questions', { query: this.query });
                this.similarQuestions = response.data.similar_questions;
              } catch (error) {
                console.error('Error fetching similar questions:', error);
              }
            }
            this.isFillingInput = false;
          },
          fillInput(question) {
            this.query = question;
            this.similarQuestions = [];
            this.isFillingInput = true;
          },
          scrollToBottom() {
            this.$refs.chatContainer.scrollTop = this.$refs.chatContainer.scrollHeight;
          },
          async fetchTopQuestions() {
            try {
              const response = await axios.get('http://127.0.0.1:5000/top_questions');
              this.topQuestions = response.data.top_questions;
            } catch (error) {
              console.error('Error fetching top questions:', error);
            }
          }
        },
        watch: {
          query(newValue) {
            if(newValue.trim().length !== 0) {
                clearTimeout(this.queryTimeout);
                this.queryTimeout = setTimeout(() => {
                this.fetchSimilarQuestions();
                }, 750);
            }
          }
        }
      });
    </script>
  </body>
</html>
